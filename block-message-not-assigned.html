<script>
(async function () {
  console.log('[BlockReplyBox] Script iniciado');

  const conversationId = window.location.pathname.split('/').pop();
  const accountId = window.location.pathname.split('/')[3];

  if (!conversationId || isNaN(conversationId)) return;

  await waitFor(() => window.axios);

  const currentUser = (await axios.get('/api/v1/profile')).data;
  const currentUserId = currentUser.id;

  const conversation = (await axios.get(`/api/v1/accounts/${accountId}/conversations/${conversationId}`)).data;
  const assigneeId = conversation.meta?.assignee?.id || conversation.assignee_id;

  if (assigneeId !== currentUserId) {
    console.log('[BlockReplyBox] UsuÃ¡rio nÃ£o Ã© o responsÃ¡vel, bloqueando envio');
    blockReplyBox();
  }

  function blockReplyBox() {
    const observer = new MutationObserver(() => {
      const replyBox = document.querySelector('.reply-box');
      if (replyBox && !replyBox.querySelector('.reply-block-overlay')) {
        const overlay = document.createElement('div');
        overlay.className = 'reply-block-overlay';
        overlay.textContent = 'ðŸš« Envio de mensagem bloqueado';
        Object.assign(overlay.style, {
          position: 'absolute',
          inset: '0',
          background: 'rgba(255, 0, 0, 0.75)',
          color: '#fff',
          fontSize: '1.2rem',
          fontWeight: 'bold',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: '9999',
          borderRadius: '8px',
          pointerEvents: 'auto'
        });
        replyBox.style.position = 'relative';
        replyBox.appendChild(overlay);
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }

  function waitFor(conditionFn, interval = 300) {
    return new Promise(resolve => {
      const i = setInterval(() => {
        if (conditionFn()) {
          clearInterval(i);
          resolve();
        }
      }, interval);
    });
  }
})();
</script>
